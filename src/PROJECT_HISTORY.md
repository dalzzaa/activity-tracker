# 프로젝트 개발 및 수정 내역 (2024-XX-XX)

이 문서는 Gemini Code Assist와의 협업을 통해 Activity Tracking 프로젝트의 문제를 해결하고 기능을 개선한 내역을 기록합니다.

---

## 1. 초기 문제: 모달 배경 오류

- **문제 요약**: 캘린더 뷰에서 '+' 버튼을 눌러 상세 뷰로 전환할 때, 모달 폼의 배경이 화면 최상단에 남아 다른 UI 조작을 막는 현상이 지속적으로 발생.
- **해결 과정**:
    1. **1차 시도 (CSS 수정)**: `#modal-backdrop`의 부모 컨테이너에 `position: relative`를 추가했으나 해결되지 않음.
    2. **2차 시도 (HTML 구조 및 CSS 수정)**: 모달 관련 요소들을 지도 컨테이너 밖으로 이동시키고 `position: fixed`로 변경했으나 해결되지 않음.
    3. **3차 시도 (중복 ID 제거)**: `index.html` 내에 `id`가 중복된 요소(`photo-preview-container`)가 있음을 발견하고 중복 요소를 제거했으나, 근본 원인이 아니었음.
    4. **4차 시도 (누락된 모달 숨김 로직 추가)**: `rerender` 함수에서 이미지 확대 모달(`image-zoom-modal`)을 숨기는 로직이 누락된 것을 발견하고, 뷰 전환 시 항상 숨겨지도록 코드를 추가했으나 해결되지 않음.
    5. **최종 해결 (CSS 명시도 문제)**: `.hidden` 클래스의 `display: none` 스타일이 다른 복잡한 선택자(`:not(.hidden)`)에 의해 무시되는 CSS 명시도(specificity) 문제를 발견. `.hidden` 클래스에 `!important`를 추가하여 문제를 최종적으로 해결.

---

## 2. 기능 개선: 메모 마커 관리

### 2.1. 메모 마커 미표시 문제

- **문제 요약**: 상세 뷰 진입 시, 이전에 저장된 메모 마커가 지도에 표시되지 않음.
- **원인**: `showDetailView` 함수가 호출될 때 실행되는 `clearPath` 함수가 경로뿐만 아니라 모든 메모 마커까지 제거하고 있었음.
- **해결**:
    - `clearPath` 함수에서는 경로 관련 요소만 지우도록 수정.
    - `clearAllLocationMarkers` 함수를 신설.
    - `showDetailView` 함수 시작 시 `clearAllLocationMarkers`를 명시적으로 호출하여, 마커를 먼저 모두 지우고 DB의 최신 상태를 기준으로 다시 그리도록 로직 변경.

### 2.2. 마커 아이콘 구분

- **요청 사항**: 현재 위치 마커와 메모 마커의 모양이 같아 구분이 어려움. 메모 마커의 아이콘을 변경 요청.
- **해결**:
    - `addLocationMarker` 함수를 수정하여 커스텀 아이콘을 적용.
    - 일반 메모는 **초록색** 마커, 사진이 첨부된 메모는 **보라색** 마커로 표시하여 시각적 구분을 명확히 함.
    - 마커 업데이트 시 관리 배열(`locationMarkers`)에서도 이전 마커를 제거(`splice`)하도록 수정하여 아이콘 변경이 올바르게 반영되도록 함.

---

## 3. 기능 개선: 경로 데이터 관리

- **문제 요약**: 경로 추적 중에 메모를 저장하면, 그때까지 기록된 이동 경로가 사라지는 현상 발생.
- **원인**: 메모 저장 시, 메모리에만 있던 최신 경로 정보(`rawPathCoordinates`)를 활동 데이터에 함께 저장하는 로직이 누락됨.
- **해결**:
    - `handleSaveMemo` (메모 저장) 함수와 `handleStopTracking` (추적 종료) 함수에, DB 업데이트 전 `getPathCoordinates()`로 최신 경로를 가져와 활동 객체에 반영하는 로직을 추가하여 데이터 소실을 방지.
    - 이 변경사항을 `CONTEXT.md`의 '데이터 저장 시점' 항목에 명시적으로 문서화.

---

## 4. UI/UX 개선

### 4.1. 메모 모달 버튼 수정

- **요청 사항**: 메모 모달의 '취소' 버튼을 '닫기'로 변경하고, '저장' 버튼을 왼쪽, '닫기' 버튼을 오른쪽으로 위치 변경.
- **해결**: `index.html` 파일의 버튼 순서와 텍스트를 수정. (초기 미반영 문제는 브라우저 캐시 문제로 확인되어 '강력 새로고침'으로 해결)

---

## 5. 기능 추가 및 버그 수정: 메모 삭제

### 5.1. 메모 삭제 기능 추가

- **요청 사항**: 메모 모달에 '메모 삭제' 버튼을 추가하여, 해당 메모와 관련 사진을 DB에서 모두 삭제하는 기능 구현.
- **해결**:
    - `CONTEXT.md`에 요구사항 추가.
    - `index.html`: 모달 헤더에 '메모 삭제' 버튼 추가 (기존 메모를 열 때만 보이도록 `.hidden` 기본 적용).
    - `indexedDB.js`: `deleteMedia` 함수 추가.
    - `main.js`: `handleDeleteMemo` 함수를 구현하여 활동 데이터에서 마커 정보를 제거하고, 관련 미디어를 모두 삭제한 뒤 UI를 갱신하도록 로직 작성.

### 5.2. 메모 삭제 미반영 문제

- **문제 요약**: '메모 삭제' 버튼을 눌러도 상세 뷰에 삭제된 마커가 계속 보이는 문제.
- **원인**: `handleDeleteMemo` 함수 내에서 DB는 정상적으로 업데이트되었으나, UI를 갱신하는 과정에서 `showDetailView` -> `clearPath`가 호출되며 마커 관리 로직에 혼선이 발생.
- **해결**: (2.1. 메모 마커 미표시 문제 해결 과정에서 함께 해결됨) `showDetailView` 함수 시작 시 `clearAllLocationMarkers`를 호출하여, 항상 DB의 최신 상태를 기준으로 마커를 그리도록 수정.

### 5.3. 메모 내 사진 삭제 미반영 문제

- **문제 요약**: 메모 수정 창에서 사진의 'x' 버튼을 눌러 삭제하고 저장해도, 메모를 다시 열면 삭제한 사진이 그대로 보이는 문제.
- **원인**: `handleSaveMemo` 함수가 사진을 저장할 때, 'x' 버튼으로 삭제된 사진의 키를 필터링하지 않고 기존 `mediaKeys` 배열을 그대로 다시 사용하고 있었음.
- **해결**:
    - `state.currentMemo`에 삭제할 사진 키를 임시로 저장하는 `deletedMediaKeys` Set을 추가.
    - `handlePreviewClick`에서는 삭제할 키를 `deletedMediaKeys`에 추가만 하도록 수정.
    - `handleSaveMemo`에서는 저장 시점에 `deletedMediaKeys`에 포함된 키들을 실제 `mediaKeys` 배열에서 필터링하고, DB에서도 최종적으로 삭제하도록 로직을 통합하여 데이터 일관성을 확보.

---